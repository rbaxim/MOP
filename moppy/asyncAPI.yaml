asyncapi: 3.1.0

info:
  title: MOP WebSocket Terminal API
  version: 1.0.0
  description: >
    Interactive PTY stream over WebSocket.

    Flow:
      1. Obtain alias via POST /mop/alias
      2. Connect to /mop/power/sock/{alias}

    Special alias:
      "Public" → shared public session

    When the websocket is connected:
      The alias instantly becomes invalid and must be regenerated if you need another one.
      Only exception is for the Public alias

servers:
  development:
    host: 127.0.0.1:8000
    protocol: ws
    description: Insecure WebSocket (development only)

  production:
    host: example.com
    protocol: wss
    description: Secure WebSocket (recommended)

channels:
  powerSocket:
    address: /mop/power/sock/{alias}
    summary: Interactive terminal WebSocket
    description: >
      Connect using alias obtained from POST /mop/alias.
      Invalid alias results in close code 1008.

    messages:
      TerminalInput:
        $ref: '#/components/messages/TerminalInput'
      TerminalOutput:
        $ref: '#/components/messages/TerminalOutput'

operations:

  receiveInput:
    action: receive
    channel:
      $ref: '#/channels/powerSocket'
    summary: Client sends stdin to server

    description: |
      Client MUST send:

        {
          "stdin": "<data>",
          "newline": false
        }

      Encoding:
        - UTF-8 string
        - URL-safe Base64 string

      Newline Behavior:

        DEFAULT (no STREAM_STDIN waiver):
          Server ALWAYS appends OS-specific newline.

        IF STREAM_STDIN waiver enabled:
          newline=true  → append OS newline
          newline=false → do NOT append newline

      stdin MUST NOT contain newline characters.

    x-rateLimit:
      type: sliding_window_decay
      max_messages: 50
      per_seconds: 1
      decay_per_second: 50
      description: >
        Rate limit is enforced per connection.
        Exceeding limit results in WebSocket close 1008.

    x-closeCodes:
      "1008":
        name: Policy Violation
        causes:
          - Invalid alias
          - Invalid JSON
          - Rate limit exceeded
      "1011":
        name: Internal Server Error
        causes:
          - ASGI framework failure
          - websocket.client not set

    messages:
      - $ref: '#/channels/powerSocket/messages/TerminalInput'

  sendOutput:
    action: send
    channel:
      $ref: '#/channels/powerSocket'
    summary: Server streams stdout and stderr

    description: |
      Server sends:

        {
          "stdout": "<data>",
          "stderr": "<data>"
        }

      Rules:

        - Both fields are strings (NOT arrays)
        - Encoding:
            UTF-8 or URL-safe Base64
        - Contains ONLY newly generated output
        - Full buffer is NOT retransmitted

    messages:
      - $ref: '#/channels/powerSocket/messages/TerminalOutput'

components:

  messages:

    TerminalInput:
      name: TerminalInput
      payload:
        type: object
        required:
          - stdin
        properties:
          stdin:
            type: string
            description: >
              Data written directly to PTY stdin.
              Must NOT contain newline characters.
              UTF-8 or URL-safe Base64.
          newline:
            type: boolean
            description: >
              Only meaningful if STREAM_STDIN waiver is enabled.
              Controls OS newline appending.
            default: false
        additionalProperties: false
        example:
          stdin: "echo hello"
          newline: true

    TerminalOutput:
      name: TerminalOutput
      payload:
        type: object
        properties:
          stdout:
            type: string
            description: >
              Newly generated stdout data.
              UTF-8 or URL-safe Base64.
          stderr:
            type: string
            description: >
              Newly generated stderr data.
              UTF-8 or URL-safe Base64.
        additionalProperties: false
        example:
          stdout: "Hello World!"
          stderr: ""
