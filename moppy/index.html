<!DOCTYPE html>
<html lang="en" class="dark bg-gray-900">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Modular Protocol Server</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            terminal: {
              bg: '#0c0c0c',
              text: '#f0f0f0',
              green: '#4ade80',
              red: '#f87171',
              blue: '#60a5fa',
            }
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
    body { font-family: 'Fira Code', monospace; }
    .terminal-text { color: #f0f0f0; }
    .blink { animation: blink 1s step-end infinite; }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body class="terminal-text min-h-screen flex flex-col items-center justify-start p-4 sm:p-6">
  <div class="w-full max-w-3xl">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-2xl font-bold text-terminal-green">Modular Protocol Server</h1>
      <p class="text-gray-400 mt-1">Interactive sessions over HTTP</p>
    </div>

    <!-- Server Status Card -->
    <div id="server-status" class="bg-gray-800 rounded-lg p-4 mb-6 border border-gray-700">
      <div class="flex justify-between items-center">
        
        <div>
          <h2 class="text-lg font-semibold">Server Status <span class="text-sm text-gray-400 font-normal" id="server-uptime">0s</span></h2>
          <p class="text-sm text-gray-400" id="command-line">Loading...</p>
        </div>
        <span id="status-indicator" class="flex items-center">
          <span class="w-3 h-3 rounded-full bg-terminal-red mr-2 blink"></span>
          <span id="status-text">Offline</span>
        </span>
      </div>
      <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
        <div>
          <span class="text-gray-400">Active Sessions:</span>
          <span id="session-count" class="ml-2 font-mono">â€”</span>
        </div>
        <div>
          <span class="text-gray-400">Public Queue:</span>
          <span id="pending-writes" class="ml-2 font-mono">â€”</span>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="space-y-4 mb-8">
      <!-- Create New Session -->
      <button id="create-session" class="w-full bg-terminal-blue hover:bg-blue-600 text-black font-bold py-2.5 px-4 rounded transition flex items-center justify-center">
        ğŸ’  Create New Private Session
      </button>

      <!-- Join Public Session -->
      <button id="join-public" class="w-full bg-gray-700 hover:bg-gray-600 py-2.5 px-4 rounded transition flex items-center justify-center">
        ğŸŒ Join Public Session
      </button>

      <!-- Rejoin Session -->
      <button id="rejoin-session" class="w-full bg-gray-700 hover:bg-gray-600 py-2.5 px-4 rounded transition flex items-center justify-center hidden" disabled>
        ğŸ” Rejoin Session
      </button>

      <!-- Join by Key -->
      <div class="flex">
        <input 
          type="text" 
          id="session-key-input" 
          placeholder="Enter session key..." 
          class="flex-grow bg-gray-800 text-white border border-gray-600 rounded-l px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-terminal-blue"
        />
        <button id="join-key" class="bg-gray-700 hover:bg-gray-600 px-4 rounded-r">
          â¤
        </button>
      </div>
      <p id="key-status" class="text-xs text-gray-500 min-h-[1.2rem]"></p>
    </div>

    <!-- Footer -->
    <div class="text-center text-xs text-gray-500">
      Keys are ephemeral â€” sessions expire on server restart.<br>
      If you are looking for your html that was created by this server, go to <a class="underline" href="/client">/client</a>.
    </div>
  </div>

  <script>
    const API_BASE = '';
    
    // DOM Elements
    const statusText = document.getElementById('status-text');
    const statusIndicator = document.querySelector('#status-indicator .w-3');
    const sessionCountEl = document.getElementById('session-count');
    const pendingWritesEl = document.getElementById('pending-writes');
    const commandLineEl = document.getElementById('command-line');
    const createBtn = document.getElementById('create-session');
    const joinPublicBtn = document.getElementById('join-public');
    const joinKeyBtn = document.getElementById('join-key');
    const keyInput = document.getElementById('session-key-input');
    const keyStatus = document.getElementById('key-status');
    const rejoinBtn = document.getElementById('rejoin-session');
    const serverUptimeEl = document.getElementById('server-uptime');
    let lastServerUptime = 0;     // uptime from last server fetch
    let lastSyncTimestamp = 0;    // timestamp when server uptime was fetched
    let lastServerId = null;
    let uptimeInterval;

    let pubKey = null;

    // Convert seconds to human-readable format
    function formatUptime(seconds) {
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        return (days > 0 ? `${days}d ` : '') +
            `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
    }

    function updateServerUptime(serverUptime, serverId) {
        // If server changed, reset
        if (lastServerId !== serverId) {
            lastServerUptime = 0;
            lastSyncTimestamp = Date.now();
            lastServerId = serverId;
        }

        // Make sure serverUptime is a number of seconds
        lastServerUptime = Number(serverUptime) || 0;
        lastSyncTimestamp = Date.now();

        // Start interval once
        if (!uptimeInterval) {
            uptimeInterval = setInterval(() => {
                const elapsedSeconds = Math.floor((Date.now() - lastSyncTimestamp) / 1000);
                const currentUptime = lastServerUptime + elapsedSeconds;
                serverUptimeEl.textContent = formatUptime(currentUptime);
            }, 1000);
        }

        // Update immediately
        serverUptimeEl.textContent = formatUptime(lastServerUptime);
    }

    // Fetch server info
    async function fetchServerStatus() {
      try {
        const res = await fetch(`${API_BASE}/mop/process`);

        const data = await res.json();

        window.commandLine = data.command.join(' ');


        updateServerUptime(data.uptime);
        
        if (res.status === 428) {
          // Server is up but no session exists yet
          commandLineEl.textContent = `$ ${window.commandLine || 'not started'}`;
          sessionCountEl.textContent = '0';
          pendingWritesEl.textContent = '0';
          statusText.textContent = 'Idle';
          statusText.className = 'text-yellow-400';
          statusIndicator.className = 'w-3 h-3 rounded-full bg-yellow-400 mr-2';
          
          pubKey = null;
          publicSessionReady = false;
          joinPublicBtn.disabled = true;
          joinPublicBtn.classList.add('opacity-50', 'cursor-not-allowed');
          createBtn.disabled = false;
          createBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          joinKeyBtn.disabled = false;
          joinKeyBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          return true; // server is reachable, just idle
        }
        
        if (!res.ok) throw new Error('Offline');

        commandLineEl.textContent = `$ ${data.command.join(' ')}`;
        sessionCountEl.textContent = data.sessions;
        pendingWritesEl.textContent = data.pending_writes;
        pubKey = data.pub_key;
        publicSessionReady = !!pubKey;
        
        // Enable public button if ready
        if (publicSessionReady) {
          joinPublicBtn.disabled = false;
          joinPublicBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
          joinPublicBtn.disabled = true;
          joinPublicBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        createBtn.disabled = false;
        createBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        joinKeyBtn.disabled = false;
        joinKeyBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        
        statusText.textContent = 'Active';
        statusText.className = 'text-terminal-green';
        statusIndicator.className = 'w-3 h-3 rounded-full bg-terminal-green mr-2';
        return true;
        
      } catch (err) {
        // Server unreachable
        statusText.textContent = 'Offline';
        statusText.className = 'text-terminal-red';
        statusIndicator.className = 'w-3 h-3 rounded-full bg-terminal-red mr-2 blink';
        joinPublicBtn.disabled = true;
        serverUptimeEl.textContent = 'Server unreachable';
        sessionCountEl.textContent = '0';
        pendingWritesEl.textContent = '0';
        pubKey = null;
        publicSessionReady = false;
        joinPublicBtn.disabled = true;
        joinPublicBtn.classList.add('opacity-50', 'cursor-not-allowed');
        createBtn.disabled = true;
        createBtn.classList.add('opacity-50', 'cursor-not-allowed');
        joinKeyBtn.disabled = true;
        joinKeyBtn.classList.add('opacity-50', 'cursor-not-allowed');
        commandLineEl.textContent = `$ unknown`;
        localStorage.removeItem('mop_key');
        lastServerUptime = 0;
        lastSyncTimestamp = 0;
        clearInterval(uptimeInterval);
        uptimeInterval = null;
        return false;
      }
    }

    // Validate and join a session
    async function joinSession(key) {
      if (!key.trim()) return;
      
      keyStatus.textContent = 'Validating...';
      keyStatus.className = 'text-xs text-gray-500';

      try {
        const res = await fetch(`${API_BASE}/mop/validate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key })
        });

        const result = await res.json();
        if (result.code === 0) {
          keyStatus.textContent = 'âœ“ Valid â€” redirecting...';
          keyStatus.className = 'text-xs text-terminal-green';
          localStorage.setItem('mop_key', key);
          window.location.href = `session`;
        } else {
          keyStatus.textContent = 'âœ— Invalid or expired session';
          keyStatus.className = 'text-xs text-terminal-red';
        }
      } catch (err) {
        keyStatus.textContent = 'âš ï¸ Validation failed';
        keyStatus.className = 'text-xs text-yellow-400';
      }
    }

    // Event Listeners
    createBtn.addEventListener('click', async () => {
      if (!await fetchServerStatus()) return;
      fetch(`${API_BASE}/mop/init`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({"echo": true}) })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          return response.json();
        })
        .then(data => {
          window.location.href = `session`;
          localStorage.setItem('mop_key', data.key);
        })
        .catch(err => {
          console.error(err);
        })
    });

    joinPublicBtn.addEventListener('click', () => {
      if (pubKey) {
        localStorage.setItem('mop_pub_key', pubKey);
        window.location.href = `session`;
      } else {
        alert('Public session not ready yet. Try again.');
      }
    });

    joinKeyBtn.addEventListener('click', () => {
      joinSession(keyInput.value);
    });

    keyInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') joinSession(keyInput.value);
    });

    async function validateSession() {
      if (localStorage.getItem('mop_key')) {
        const res = await fetch(`${API_BASE}/mop/validate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key: localStorage.getItem('mop_key') })
          });
        let result = await res.json();
        if (result.code != 0) {
          localStorage.removeItem('mop_key');
        }
        else {
          rejoinBtn.classList.remove('hidden');
          rejoinBtn.disabled = false;
          rejoinBtn.addEventListener('click', () => {
            window.location.href = `session`;
          });
        }
      }
    }

    document.addEventListener('DOMContentLoaded', async () => { await validateSession() });

    // Initial load
    fetchServerStatus();
    setInterval(fetchServerStatus, 5000); // refresh every 5s
  </script>
</body>
</html>